<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Equity Crew 26 | Elite Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --gold: #d4af37; --emerald: #064e3b; --deep-green: #022c22;
            --glass: rgba(2, 44, 34, 0.98); --border: rgba(212, 175, 55, 0.2); --crimson: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--deep-green);
            color: white; min-height: 100vh; padding-bottom: 90px;
        }

        .hidden { display: none !important; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .cambria { font-family: 'Cambria', serif; }

        /* Luxury Deco */
        .deco-gold { border: 2px solid var(--gold) !important; background: linear-gradient(45deg, #022c22, #064e3b) !important; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        
        .elite-card {
            background: rgba(255, 255, 255, 0.05); border-radius: 20px; border: 1px solid var(--border);
            padding: 15px; margin-bottom: 15px; backdrop-filter: blur(10px);
        }

        .btn-luxury {
            padding: 12px 18px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, var(--gold), #b08d29);
            color: #022c22; font-weight: 800; cursor: pointer; font-size: 0.7rem; text-transform: uppercase;
        }

        .form-input {
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px;
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: white; outline: none;
        }

        /* Post Styles */
        .post-media { width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid var(--border); }
        
        /* Chat Bubbles */
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 15px; margin-bottom: 8px; font-size: 0.85rem; }
        .sent { background: var(--gold); color: #022c22; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: rgba(255,255,255,0.1); color: white; align-self: flex-start; border-bottom-left-radius: 2px; }

        /* Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--glass);
            display: flex; justify-content: space-around; padding: 12px 10px 25px;
            border-top: 1px solid var(--border); z-index: 1000;
        }
        .nav-link { color: rgba(212, 175, 55, 0.3); display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-link.active { color: var(--gold); }

        /* Print A4 Style */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 210mm; color: black !important; }
        }
    </style>
</head>
<body>

    <div id="auth-screen" class="container" style="padding-top: 60px;">
        <div class="elite-card" style="text-align:center; padding: 30px;">
            <h1 class="cambria" style="color:var(--gold); font-size: 2.5rem; letter-spacing: 2px;">EQUITY 26</h1>
            <p style="font-size: 0.6rem; opacity: 0.6; letter-spacing: 3px; margin-bottom: 30px;">OFFICIAL FACULTY HUB</p>
            
            <div id="auth-choice">
                <button class="btn-luxury" style="width:100%; margin-bottom:12px;" onclick="showReg(false)">Student Entry</button>
                <button class="btn-luxury" style="width:100%; background:transparent; color:var(--gold); border:1px solid var(--gold);" onclick="gate()">Executive Entry</button>
            </div>

            <div id="reg-form" class="hidden">
                <input type="text" id="reg-name" class="form-input" placeholder="Name">
                <input type="text" id="reg-matric" class="form-input" placeholder="Matric / ID No">
                <div id="exec-fields" class="hidden">
                    <p style="font-size: 0.6rem; color: var(--gold); margin-bottom: 5px;">Council Access Verified</p>
                </div>
                <button class="btn-luxury" style="width:100%;" onclick="handleAuth()">Enter Hub</button>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <header style="padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: var(--deep-green); position: sticky; top: 0; z-index: 100;">
            <div class="cambria" style="color:var(--gold); font-weight:800; font-size: 1.1rem;">ELITE HUB</div>
            <img id="u-pfp" style="width:32px; height:32px; border-radius:50%; border:1px solid var(--gold);">
        </header>

        <div class="container">
            <section id="tab-feed">
                <div class="elite-card">
                    <textarea id="post-text" class="form-input" placeholder="Post a faculty update..." style="height:70px; resize:none; border:none; background:transparent;"></textarea>
                    <div id="preview-container" style="display:none; margin-bottom: 10px;">
                        <img id="post-preview" style="width:60px; height:60px; border-radius:8px; object-fit:cover;">
                    </div>
                    <div style="display:flex; justify-content: space-between; align-items: center;">
                        <div style="display:flex; gap:15px; color: var(--gold);">
                            <label style="cursor:pointer;"><i data-lucide="paperclip"></i>
                                <input type="file" id="post-file" class="hidden" accept="image/*" onchange="handleFile(this)">
                            </label>
                            <i data-lucide="award" onclick="toggleDeco()" id="deco-btn" style="cursor:pointer; opacity: 0.4;"></i>
                        </div>
                        <button class="btn-luxury" id="post-btn" onclick="publishPost()">Publish</button>
                    </div>
                    <div id="upload-status" style="font-size:0.6rem; margin-top:5px; color:var(--gold);"></div>
                </div>
                <div id="feed-display"></div>
            </section>

            <section id="tab-chat" class="hidden">
                <h3 class="cambria" style="color:var(--gold); margin-bottom:15px;">Executive Directory</h3>
                <div id="chat-list"></div>
            </section>

            <section id="tab-profile" class="hidden">
                <div class="elite-card" style="text-align:center; padding: 30px 15px;">
                    <img id="p-img" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--gold); margin-bottom: 15px;">
                    <h2 id="p-name" class="cambria"></h2>
                    <p id="p-role" style="font-size: 0.7rem; color: var(--gold); text-transform: uppercase; letter-spacing: 2px;"></p>
                    
                    <div style="margin-top: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="elite-card" style="margin:0; padding:10px;"><small style="display:block; opacity:0.5;">Status</small><b>Active</b></div>
                        <div class="elite-card" style="margin:0; padding:10px;"><small style="display:block; opacity:0.5;">Level</small><b>Council</b></div>
                    </div>

                    <button class="btn-luxury" style="margin-top:20px; width:100%; background:var(--crimson); color:white;" onclick="logout()">Disconnect</button>
                </div>
            </section>
        </div>

        <nav class="bottom-nav">
            <div class="nav-link active" onclick="switchTab('feed')"><i data-lucide="layers"></i><small>Feed</small></div>
            <div class="nav-link" onclick="switchTab('chat')"><i data-lucide="message-circle"></i><small>Inbox</small></div>
            <div class="nav-link" onclick="switchTab('profile')"><i data-lucide="user"></i><small>Profile</small></div>
        </nav>
    </div>

    <div id="chat-drawer" class="hidden" style="position:fixed; inset:0; background:var(--deep-green); z-index:2000; display:flex; flex-direction:column;">
        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px;">
            <i data-lucide="arrow-left" onclick="closeChat()"></i>
            <b id="chat-target" class="cambria" style="color:var(--gold);"></b>
        </div>
        <div id="chat-msgs" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column;"></div>
        <div style="padding:15px; display:flex; gap:10px; background: rgba(0,0,0,0.2);">
            <input type="text" id="msg-input" class="form-input" style="margin:0;" placeholder="Message...">
            <button class="btn-luxury" onclick="sendMsg()" style="padding:10px;"><i data-lucide="send"></i></button>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAgIOS8MY4myQYQe2W_FihFY0f7ZA0I_dg",
            authDomain: "dolpgrace01.firebaseapp.com",
            projectId: "dolpgrace01",
            storageBucket: "dolpgrace01.firebasestorage.app",
            appId: "1:61754484780:web:8b1aa1faaf337d66b7c989"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let user = JSON.parse(localStorage.getItem('ec26_user'));
        let isExec = false;
        let base64Image = "";
        let activeChat = null;
        let decoEnabled = false;

        window.onload = () => { if(user) showApp(); lucide.createIcons(); };

        // AUTH LOGIC
        function gate() { if(prompt("Passcode:") === "1234") { isExec = true; showReg(true); } }
        function showReg(t) {
            document.getElementById('auth-choice').classList.add('hidden');
            document.getElementById('reg-form').classList.remove('hidden');
            if(isExec) document.getElementById('exec-fields').classList.remove('hidden');
        }

        async function handleAuth() {
            const n = document.getElementById('reg-name').value;
            const m = document.getElementById('reg-matric').value;
            if(!n) return alert("Name required");
            user = { id: "U"+Date.now(), name: n, matric: m, isExec, pic: `https://api.dicebear.com/7.x/avataaars/svg?seed=${n}`, role: isExec ? "Council Executive" : "Student Member" };
            localStorage.setItem('ec26_user', JSON.stringify(user));
            await db.collection("users").doc(user.id).set(user);
            showApp();
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('u-pfp').src = user.pic;
            document.getElementById('p-img').src = user.pic;
            document.getElementById('p-name').innerText = user.name;
            document.getElementById('p-role').innerText = user.role;
            renderFeed(); renderChats();
        }

        // IMAGE HANDLING (BASE64)
        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            if(file.size > 800000) return alert("Image too large. Max 800kb.");
            
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Image = e.target.result;
                document.getElementById('preview-container').style.display = "block";
                document.getElementById('post-preview').src = base64Image;
                document.getElementById('upload-status').innerText = "Image Ready âœ¨";
            };
            reader.readAsDataURL(file);
        }

        function toggleDeco() {
            decoEnabled = !decoEnabled;
            document.getElementById('deco-btn').style.opacity = decoEnabled ? "1" : "0.4";
        }

        // POST LOGIC
        async function publish() {
    const txt = document.getElementById('post-text').value;
    // Check if both are empty
    if (!txt && !imgStr) {
        alert("Master, you cannot publish an empty update.");
        return;
    }

    const btn = document.getElementById('pub-btn');
    btn.innerText = "Syncing...";
    btn.disabled = true;

    try {
        await db.collection("posts").add({
            uid: user.id,
            name: user.name,
            pic: user.pic,
            txt: txt,
            img: imgStr, // This is the Base64 string
            deco: isDeco,
            likes: [],
            reports: 0,
            time: firebase.firestore.FieldValue.serverTimestamp()
        });

        // SUCCESS: Clear everything
        document.getElementById('post-text').value = "";
        imgStr = "";
        document.getElementById('pre-box').classList.add('hidden');
        isDeco = false;
        document.getElementById('deco-ico').style.opacity = "0.3";
        btn.innerText = "Publish";
        btn.disabled = false;
        console.log("Post Sync Successful");

    } catch (error) {
        // ERROR: This will tell you if the image is too big or rules are wrong
        console.error("Sync Error:", error);
        alert("Post Failed: " + error.message);
        btn.innerText = "Publish";
        btn.disabled = false;
    }
}
        function renderFeed() {
            db.collection("posts").orderBy("time", "desc").onSnapshot(snap => {
                const f = document.getElementById('feed-display'); f.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    f.innerHTML += `
                        <div class="elite-card ${d.deco ? 'deco-gold' : ''}">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                                <img src="${d.pic}" style="width:25px; border-radius:50%;">
                                <b style="font-size:0.7rem;">${d.name}</b>
                            </div>
                            <p style="font-size:0.8rem;">${d.txt}</p>
                            ${d.file ? `<img src="${d.file}" class="post-media">` : ''}
                            <div style="margin-top:10px; font-size:0.7rem; color:var(--gold); display:flex; gap:15px;">
                                <span onclick="like('${doc.id}')" style="cursor:pointer;"><i data-lucide="heart" style="width:14px;"></i> ${d.likes.length}</span>
                            </div>
                        </div>`;
                });
                lucide.createIcons();
            });
        }

        async function like(pid) {
            const ref = db.collection("posts").doc(pid);
            const d = await ref.get();
            let l = d.data().likes || [];
            l.includes(user.id) ? l = l.filter(i => i !== user.id) : l.push(user.id);
            await ref.update({ likes: l });
        }

        // CHAT LOGIC
        function renderChats() {
            const list = document.getElementById('chat-list');
            const targetQuery = user.isExec ? db.collection("users").where("isExec", "==", false) : db.collection("users").where("isExec", "==", true);
            
            targetQuery.onSnapshot(snap => {
                list.innerHTML = "";
                snap.forEach(doc => {
                    const u = doc.data();
                    list.innerHTML += `
                        <div class="elite-card" onclick="openChat('${u.id}', '${u.name}')" style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                            <img src="${u.pic}" style="width:35px; border-radius:50%; border:1px solid var(--gold);">
                            <div><b>${u.name}</b><br><small style="opacity:0.5; font-size:0.6rem;">${u.role}</small></div>
                        </div>`;
                });
            });
        }

        function openChat(id, name) {
            activeChat = id; document.getElementById('chat-target').innerText = name;
            document.getElementById('chat-drawer').classList.remove('hidden');
            const rid = [user.id, id].sort().join('_');
            db.collection("chats").doc(rid).collection("m").orderBy("time", "asc").onSnapshot(snap => {
                const b = document.getElementById('chat-msgs'); b.innerHTML = "";
                snap.forEach(m => {
                    const d = m.data();
                    b.innerHTML += `<div class="chat-bubble ${d.sid === user.id ? 'sent' : 'received'}">${d.t}</div>`;
                });
                b.scrollTop = b.scrollHeight;
            });
        }

        async function sendMsg() {
            const t = document.getElementById('msg-input').value; if(!t) return;
            const rid = [user.id, activeChat].sort().join('_');
            await db.collection("chats").doc(rid).collection("m").add({ sid: user.id, t, time: firebase.firestore.FieldValue.serverTimestamp() });
            document.getElementById('msg-input').value = "";
        }

        // TABS
        function switchTab(t) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            event.currentTarget.classList.add('active');
            lucide.createIcons();
        }

        function closeChat() { document.getElementById('chat-drawer').classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>

    
</body>
</html>